# 飞牛OS虚拟机备份脚本

一个专为飞牛OS设计的全交互式QCow2虚拟机备份Shell脚本，支持定时任务、可视化操作和自动管理。

## 功能特性

- 🔄 **智能备份管理**：自动关机→备份→清理→开机流程
- 🎯 **全交互式操作**：可视化菜单选择，无需手动编写复杂配置
- ⏰ **定时任务支持**：无需编写crontab规则，可视化添加/删除定时任务
- 📊 **详细信息展示**：显示虚拟机状态、路径、文件大小等详细信息
- 🧹 **自动清理机制**：可配置保留最新备份份数，自动清理旧备份
- 📝 **完整日志记录**：详细的操作日志和错误记录
- 🛡️ **安全保障**：root权限保障，备份文件完整性校验
- 🚀 **后台运行**：支持后台运行，不中断终端操作

## 环境要求

- 操作系统：飞牛OS (基于KVM/QEMU的虚拟化环境)
- 必需工具：`virsh`、`rsync`、`crontab`
- 权限要求：需要root权限运行

## 安装配置

1. 下载脚本文件：
```bash
# 确保脚本具有执行权限
chmod +x vm_backup.sh
```

2. 修改配置参数（编辑脚本文件开头的配置项）：
```bash
# 备份目标目录（请修改为实际路径）
BACKUP_DIR="/vol4/1000/12T存储（重要文件）/虚拟机备份"
# 保留最新备份份数
KEEP_BACKUP_COUNT=3
# 虚拟机关机超时时间（秒）
SHUTDOWN_TIMEOUT=120
# 虚拟机开机等待时间（秒）
BOOT_WAIT_TIME=30
```

## 使用方法

### 1. 交互式备份（推荐）
```bash
sudo ./vm_backup.sh
```
- 显示所有虚拟机详细信息（状态、路径、大小）
- 支持多选虚拟机进行备份
- 确认后自动执行备份流程

### 2. 一键备份全部虚拟机
```bash
sudo ./vm_backup.sh -v
```
- 自动备份所有检测到的虚拟机
- 后台运行，不阻塞终端

### 3. 定时任务管理
```bash
sudo ./vm_backup.sh -c
```
进入定时任务管理菜单：
- 查看已添加的定时任务
- 添加新的定时任务（可视化时间选择）
- 删除现有定时任务

## 定时任务配置

脚本提供完全可视化的定时任务配置：

### 支持的定时类型
1. **每天执行**：每天指定时间自动备份全部虚拟机
2. **每周执行**：每周指定星期和时间自动备份
3. **每月执行**：每月指定日期和时间自动备份

### 示例配置流程
```bash
sudo ./vm_backup.sh -c
# 选择 "2. 添加新的定时任务"
# 选择 "1. 每天执行"
# 输入小时：2    # 凌晨2点执行
# 确认添加
```

## 备份流程说明

### 标准备份流程
1. **关机阶段**：
   - 优雅关机（graceful shutdown）
   - 超时后强制关机（force shutdown）
   
2. **备份阶段**：
   - 使用rsync增量备份QCow2文件
   - 支持稀疏文件（sparse files）处理
   - 备份完成后进行文件大小校验
   
3. **清理阶段**：
   - 自动清理超过保留份数的旧备份
   - 按时间倒序保留最新备份
   
4. **开机阶段**：
   - 如果原虚拟机为运行状态，则自动开机
   - 等待指定时间确保虚拟机完全启动

### 备份文件命名规则
```
{虚拟机名称}_{时间戳}.qcow2
例如：ubuntu_20241210_143022.qcow2
```

## 日志文件

- **主日志**：`/var/log/vm_backup.log`
  - 记录所有备份操作的详细信息
  - 包含成功/失败状态和文件大小信息
  
- **定时任务日志**：`/var/log/vm_backup_cron.log`
  - 记录定时任务执行的输出
  - 便于排查定时任务问题

## 安全特性

- **权限检查**：强制要求root权限运行
- **路径验证**：验证QCow2文件存在性
- **完整性校验**：备份前后文件大小对比
- **错误处理**：完善的错误处理和回滚机制

## 故障排除

### 常见问题

1. **权限不足**
   ```bash
   # 确保使用sudo运行
   sudo ./vm_backup.sh
   ```

2. **虚拟机检测不到**
   ```bash
   # 检查virsh是否正常工作
   sudo virsh list --all
   ```

3. **备份目录权限问题**
   ```bash
   # 确保备份目录有写权限
   sudo mkdir -p /your/backup/path
   sudo chmod 755 /your/backup/path
   ```

4. **定时任务不生效**
   ```bash
   # 检查crontab服务状态
   sudo systemctl status cron
   # 查看当前定时任务
   sudo crontab -u root -l
   ```

## 配置参数详解

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `BACKUP_DIR` | `/vol4/1000/12T存储（重要文件）/虚拟机备份` | 备份文件存储目录 |
| `KEEP_BACKUP_COUNT` | `3` | 保留最新备份份数 |
| `SHUTDOWN_TIMEOUT` | `120` | 虚拟机关机超时时间（秒） |
| `BOOT_WAIT_TIME` | `30` | 虚拟机开机等待时间（秒） |
| `LOG_FILE` | `/var/log/vm_backup.log` | 主日志文件路径 |
| `CRON_LOG_FILE` | `/var/log/vm_backup_cron.log` | 定时任务日志文件路径 |

## 技术实现

- **虚拟化管理**：基于libvirt/virsh API
- **备份算法**：rsync增量备份 + 稀疏文件支持
- **任务调度**：crontab定时任务 + nohup后台运行
- **错误处理**：多层错误检查和自动重试机制

## 许可证

本项目为开源项目，可自由使用和修改。

## 贡献

欢迎提交问题反馈和改进建议。